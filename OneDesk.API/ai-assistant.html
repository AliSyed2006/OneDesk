<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OneDesk AI Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background-color: #121212; color: #f1f1f1; font-family: Arial, sans-serif; padding: 2rem; }
    #chat { height: 70vh; overflow-y: auto; background: #1f1f1f; padding: 1rem; border-radius: 8px; border: 1px solid #444; margin-bottom: 1rem; }
    .message { margin-bottom: 1rem; }
    .message.user { color: #7dcfff; }
    .message.ai { color: #a3f7bf; }
    .message.system { color: #ffc107; }
    input#userInput { width: 100%; padding: 0.75rem; border-radius: 6px; border: none; background: #2a2a2a; color: white; }
    input#userInput:focus { outline: none; background: #333; }
    .btn-send { margin-top: 0.5rem; }
  </style>
</head>
<body>
  <h2>üß† OneDesk AI Assistant</h2>
  <div id="chat"></div>
  <input type="text" id="userInput" placeholder="Type your request and press Enter..." />
  <button class="btn btn-primary btn-send" onclick="sendMessage()">Send</button>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('userInput');
    const ollamaApi = 'http://localhost:11434/api/generate';
    const backendApi = 'http://localhost:5062/api';
    const fallbackParserApi = `${backendApi}/ai/parse`;

    const systemPrompt = `
You are an AI assistant for a business inventory system.

üìå Your ONLY task is to respond with a single, valid JSON object. No natural language, no markdown.
üìå Every response must start with this exact prefix: üí°JSON:

üí°JSON:
{ "action": ..., "data": { ... } }

üß† Supported Actions & Examples:

1Ô∏è‚É£ Add a new item:
üí°JSON:
{
  "action": "add",
  "data": {
    "name": "Apple iPhone 15",
    "sku": "IPH-15-512",
    "description": "512GB, Black",
    "category": "Electronics",
    "supplier": "Apple Inc.",
    "quantityInStock": 12,
    "costPrice": 70000,
    "sellingPrice": 82000,
    "createdAt": "auto"
  }
}

2Ô∏è‚É£ Delete an item by ID:
üí°JSON:
{
  "action": "delete",
  "data": {
    "id": 17
  }
}

3Ô∏è‚É£ Get all inventory:
üí°JSON:
{
  "action": "get",
  "data": {
    "type": "all"
  }
}

4Ô∏è‚É£ Get item by ID:
üí°JSON:
{
  "action": "get",
  "data": {
    "type": "id",
    "id": 13
  }
}

5Ô∏è‚É£ Get item by name:
üí°JSON:
{
  "action": "get",
  "data": {
    "type": "name",
    "name": "laptop"
  }
}

6Ô∏è‚É£ Record a sale:
üí°JSON:
{
  "action": "sale",
  "data": {
    "inventoryId": 13,
    "quantitySold": 2,
    "soldAt": "auto"
  }
}

üîí Rules:
- Always use double quotes and strict JSON.
- Do not include any explanation or markdown.
- Always start with "üí°JSON:" exactly once and return only one JSON object.
`;

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;

      appendMessage('You', text, 'user');
      appendMessage('AI', '‚è≥ Processing...', 'system');
      input.value = '';

      const fullPrompt = `${systemPrompt}\nUser: ${text}\nAI:`;

      try {
        const res = await fetch(ollamaApi, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: "nous-hermes2:latest",
            prompt: fullPrompt,
            stream: false
          })
        });

        const result = await res.json();

        if (result.error) {
          appendMessage('AI', `‚ùå Ollama Error: ${result.error}`, 'ai');
          return;
        }

        const rawJson = extractJSON(result.response);
        if (!rawJson) {
          appendMessage('AI', '‚ùå AI Error: Invalid or missing JSON. Trying fallback...', 'ai');
          return tryFallback(text);
        }

        const json = JSON.parse(rawJson);
        appendMessage('AI', `<pre><code>${JSON.stringify(json, null, 2)}</code></pre>`, 'ai');
        await handleAction(json);
      } catch (e) {
        appendMessage('AI', '‚ùå AI Error: ' + e.message, 'ai');
      }
    }

    function extractJSON(output) {
      if (!output || typeof output !== 'string') return null;
      const marker = 'üí°JSON:';
      const idx = output.indexOf(marker);
      if (idx === -1) return null;
      return output.slice(idx + marker.length).trim();
    }

    async function tryFallback(text) {
      try {
        const res = await fetch(fallbackParserApi, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: text })
        });
        const json = await res.json();
        appendMessage('AI (fallback)', `<pre><code>${JSON.stringify(json, null, 2)}</code></pre>`, 'ai');
        await handleAction(json);
      } catch (e) {
        appendMessage('AI', '‚ùå Fallback failed: ' + e.message, 'ai');
      }
    }

    async function handleAction(json) {
      switch (json.action) {
        case 'add':
          if (json.data.createdAt === 'auto') json.data.createdAt = new Date().toISOString();
          await backendCall('/Inventory', 'POST', json.data);
          break;
        case 'delete':
          await backendCall(`/Inventory/${json.data.id}`, 'DELETE');
          break;
        case 'sale':
          await backendCall('/Sales', 'POST', json.data);
          break;
        case 'get':
          let items = [];
          if (json.data.type === 'all') {
            items = await backendCall('/Inventory', 'GET');
          } else if (json.data.type === 'id') {
            const item = await backendCall(`/Inventory/${json.data.id}`, 'GET');
            items = item ? [item] : [];
          } else if (json.data.type === 'name') {
            const all = await backendCall('/Inventory', 'GET');
            const name = json.data.name.toLowerCase();
            items = all.filter(item => item.name.toLowerCase().includes(name));
          }
          appendMessage('üì¶ Items:', formatTable(items), 'ai');
          break;
        default:
          appendMessage('AI', `‚ùì Unknown action "${json.action}"`, 'ai');
      }
    }

    async function backendCall(endpoint, method, data = null) {
      const url = backendApi + endpoint;
      const res = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: data ? JSON.stringify(data) : null
      });

      const resultText = await res.text();
      appendMessage('‚úÖ', `${method} ${endpoint} ‚Üí ${res.status}`, 'system');
      return JSON.parse(resultText || '[]');
    }

    function appendMessage(sender, text, type) {
      const msg = document.createElement('div');
      msg.className = `message ${type}`;
      msg.innerHTML = `<strong>${sender}:</strong><br/>${text}`;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function formatTable(data) {
      if (!Array.isArray(data) || !data.length) return 'No items found.';
      const keys = Object.keys(data[0]);
      let html = `<table class="table table-dark table-sm table-bordered"><thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead><tbody>`;
      data.forEach(row => {
        html += `<tr>${keys.map(k => `<td>${row[k]}</td>`).join('')}</tr>`;
      });
      html += '</tbody></table>';
      return html;
    }
  </script>
</body>
</html>
